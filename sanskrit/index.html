<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shuklam Baradharam: The Cosmic Code</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700&family=Rajdhani:wght@400;600&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #0f172a;
            --card-bg: #1e293b;
            --text: #e2e8f0;
            --accent: #38bdf8;
            --code-text: #a5b4fc;
            --guru: #ef4444;
            --laghu: #10b981;
            --gold: #f59e0b;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: var(--bg);
            color: var(--text);
            padding: 40px;
            margin: 0;
            line-height: 1.6;
        }

        h1,
        h2,
        h3 {
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #94a3b8;
            margin-bottom: 50px;
            font-size: 1.1em;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr;
            gap: 40px;
        }

        @media(min-width: 1000px) {
            .container.split {
                grid-template-columns: 1fr 1fr;
            }
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            border: 1px solid #334155;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        /* --- VERSE STYLING --- */
        .sanskrit-verse {
            font-family: 'Noto Sans Devanagari', sans-serif;
            font-size: 2em;
            text-align: center;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.6;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
        }

        /* --- WORD GRID --- */
        .word-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .word-card {
            background: rgba(15, 23, 42, 0.6);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #334155;
            transition: transform 0.2s;
        }

        .word-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent);
        }

        .sanskrit-word {
            color: var(--accent);
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .english-meaning {
            color: #cbd5e1;
            font-size: 0.95em;
        }

        /* --- COMPUTATIONAL SECTION --- */
        .code-block {
            background: #000;
            padding: 20px;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--code-text);
            overflow-x: auto;
            border: 1px solid #333;
            margin-top: 15px;
        }

        .step-label {
            color: #64748b;
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
            display: block;
        }

        .binary-strip {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            justify-content: center;
        }

        .bit {
            width: 20px;
            height: 30px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: sans-serif;
            font-size: 0.8em;
            color: rgba(0, 0, 0, 0.7);
        }

        .bit.guru {
            background: var(--guru);
            box-shadow: 0 0 5px var(--guru);
        }

        .bit.laghu {
            background: var(--laghu);
            box-shadow: 0 0 5px var(--laghu);
        }

        .bit-mini {
            width: 8px;
            height: 8px;
            border-radius: 2px;
            display: inline-block;
        }

        .bit-mini.guru {
            background: var(--guru);
        }

        .bit-mini.laghu {
            background: var(--laghu);
        }

        .grammar-section {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dotted #475569;
            font-size: 0.85em;
        }

        .sutra-ref {
            color: #f472b6;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85em;
            display: block;
            margin-top: 5px;
            background: rgba(244, 114, 182, 0.1);
            padding: 4px;
            border-radius: 4px;
        }

        .root-def {
            color: #94a3b8;
            font-style: italic;
            margin-top: 4px;
        }

        .split-view {
            color: #e2e8f0;
            font-size: 0.9em;
        }

        .comp {
            color: var(--accent);
            font-weight: bold;
        }

        .root-hl {
            color: var(--gold);
            font-weight: bold;
        }

        .calc-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #334155;
        }

        .calc-val {
            color: var(--gold);
            font-weight: bold;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.2em;
        }

        /* Meru Canvas */
        .canvas-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        canvas {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .final-badge {
            background: linear-gradient(135deg, var(--gold), #b45309);
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-top: 20px;
            font-weight: bold;
            font-size: 1.2em;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
        }

        /* Elemental Activation */
        .energy-section {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .energy-bar-container {
            display: flex;
            height: 16px;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 10px;
            background: #334155;
        }

        .energy-seg {
            height: 100%;
            transition: width 1s ease-out;
        }

        .energy-legend {
            display: flex;
            justify-content: center;
            gap: 15px;
            font-size: 0.85em;
            margin-top: 8px;
            color: #94a3b8;
            font-weight: bold;
            flex-wrap: wrap;
        }

        .e-ether {
            background: #a855f7;
        }

        .e-air {
            background: #f59e0b;
        }

        .e-fire {
            background: #ef4444;
        }

        .e-water {
            background: #3b82f6;
        }

        .e-earth {
            background: #10b981;
        }

        .version-badge {

            .version-badge {
                background: #10b981;
                color: #000;
                padding: 2px 6px;
                border-radius: 4px;
                font-size: 0.7em;
                vertical-align: middle;
                margin-left: 10px;
            }
    </style>
</head>

<body>

    <h1>Shuklam Baradharam <span class="version-badge">PANINI MODE</span></h1>
    <div class="subtitle">The Cosmic Code Generator • Meru OS Analysis</div>

    <div class="container">

        <!-- SECTION 1: THE VERSE -->
        <div class="card">
            <div class="step-label">Input Source</div>
            <div class="sanskrit-verse">
                शुक्लाम्बरधरं विष्णुं शशिवर्णं चतुर्भुजम् ।<br>
                प्रसन्नवदनं ध्यायेत् सर्वविघ्नोपशान्तये ॥
            </div>

            <!-- Elemental Activation -->
            <div class="energy-section">
                <div class="step-label" style="text-align:center">Elemental Activation (Phonetic Spectrum)</div>
                <div class="energy-bar-container" id="energyBar">
                    <!-- JS Injected -->
                </div>
                <div class="energy-legend">
                    <span style="color:#a855f7">Ether (Throat)</span>
                    <span style="color:#f59e0b">Air (Palate)</span>
                    <span style="color:#ef4444">Fire (Roof)</span>
                    <span style="color:#3b82f6">Water (Teeth)</span>
                    <span style="color:#10b981">Earth (Lips)</span>
                </div>
            </div>

            <div class="step-label">Semantic & Digital Decoding (Word-by-Word)</div>
            <div class="word-grid" id="wordGrid">
                <!-- Generated by JS -->
            </div>
        </div>

        <!-- SECTION 2: COMPUTATIONAL LOGIC -->
        <div class="container split">

            <!-- LEFT: PRIME GENERATION -->
            <div class="card">
                <h2>1. The Verse Digitization</h2>
                <p style="color:#aaa; font-size:0.9em;">
                    Concatenating the individual word codes into the full verse stream.
                    <br><span style="color:var(--guru)">Red = Guru (Long/1)</span>, <span
                        style="color:var(--laghu)">Green = Laghu (Short/0)</span>
                </p>

                <div class="step-label">Step 1: Metric Scan (Pingala Algorithm)</div>
                <div class="binary-strip" id="binaryStrip"></div>

                <div class="step-label">Step 2: Binary Stream</div>
                <div class="code-block" id="binaryRaw">Detecting...</div>

                <h2>2. The Prime Seal</h2>
                <div class="calc-row">
                    <span>Decimal Identity:</span>
                    <span class="calc-val" id="decimalVal">...</span>
                </div>
                <div class="calc-row">
                    <span>Prime Status:</span>
                    <span class="calc-val" id="primeStatus">...</span>
                </div>

                <div class="code-block">
                    <div class="step-label">Prime Factors (The Harmonic Signature)</div>
                    <div id="factorsVal" style="color:#fff;">Calculating...</div>
                </div>

                <div class="final-badge" id="finalCode">
                    GENERATING COSMIC HASH...
                </div>
            </div>

            <!-- RIGHT: MERU PRASTARA -->
            <div class="card">
                <h2>3. The Fractal Path</h2>
                <p style="color:#aaa; font-size:0.9em;">
                    Mapping the verse's rhythm onto the Meru Prastara (Pascal's Triangle). This geometric path is the
                    "Seed" of the verse.
                </p>
                <div class="canvas-container">
                    <canvas id="meruCanvas" width="400" height="400"></canvas>
                </div>
                <div class="code-block" style="margin-top:20px;">
                    <div class="step-label">Geometry Data</div>
                    <div>Depth: <span style="color:var(--accent)">32 Syllables</span></div>
                    <div>Path Complexity: <span style="color:var(--accent)">High (Anushtubh Meter)</span></div>
                </div>
            </div>

        </div>

        <!-- SECTION 3: THE SONIC RESURRECTION -->
        <div class="card" style="border-color: var(--guru);">
            <div class="step-label" style="color:var(--guru)">Step 4: The Sonic Resurrection (Verification)</div>
            <h2 style="color:#fff; margin-bottom:10px;">The Panini Graph Path</h2>
            <p style="color:#94a3b8; font-size:0.95em; line-height:1.6; margin-bottom:20px;">
                We store only the <strong>Path Trajectory</strong> through the Grammar Graph.
                <br>Path ID: <span style="color:var(--gold); font-family:'JetBrains Mono'">1.951.4.6.1.101.9</span>
            </p>

            <!-- GRAPH VISUALIZATION (FRACTAL) -->
            <div
                style="background: rgba(0,0,0,0.3); border-radius:12px; padding:20px; overflow-x:auto; text-align:center;">
                <canvas id="paniniFracCanvas" width="600" height="400" style="background: transparent;"></canvas>
            </div>

            <div style="text-align: center; margin-top: 10px; font-size: 0.85em; color: #64748b;">
                <span style="color:#a855f7">Root √dhṛ (1.951)</span> →
                <span style="color:#3b82f6">Suffix (4)</span> →
                <span style="color:#ef4444">Sandhi (101)</span> →
                <span style="color:#10b981">Output (9)</span>
                <br>
                Graph Compression Ratio: <span style="color:#10b981; font-weight:bold;">99.9%</span>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button onclick="restoreVerse()" style="
                    background: linear-gradient(135deg, var(--guru), #b91c1c);
                    color: #fff;
                    border: none;
                    padding: 12px 25px;
                    border-radius: 6px;
                    font-family: 'Rajdhani', sans-serif;
                    font-weight: 600;
                    letter-spacing: 1px;
                    cursor: pointer;
                    font-size: 1.1em;
                    box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
                    transition: all 0.3s;
                    text-transform: uppercase;
                ">⚠️ Execute Path & Restore</button>
            </div>

            <div id="restorationArea" style="
                margin-top: 30px;
                text-align: center;
                font-family: 'Noto Sans Devanagari', sans-serif;
                font-size: 2em;
                min-height: 80px;
                color: var(--accent);
                text-shadow: 0 0 15px rgba(56, 189, 248, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
            "></div>
        </div>

    </div>

    <script>
        // === DATA ===
        const verseData = [
            {
                text: "Śuklāmbaradharaṁ",
                meaning: "Wearing Pure White (Ether)",
                binary: "111001",
                split: "<span class='comp'>Śukla</span> (White) + <span class='comp'>Ambara</span> (Sky) + <span class='comp'>Dharaṁ</span> (Wearer)",
                root: "From Root <span class='root-hl'>√dhṛ</span> (To Hold/Sustain)",
                rule: "<strong>6.1.101 Akaḥ Savarṇe Dīrghaḥ:</strong> a + a = ā (Long Vowel Sandhi)"
            },
            {
                text: "Viṣṇuṁ",
                meaning: "The All-Pervading",
                binary: "11",
                split: "<span class='comp'>Viṣ</span> (Pervade) + <span class='comp'>nu</span> (Suffix)",
                root: "From Root <span class='root-hl'>√viṣ</span> (To Enter/Pervade)",
                rule: "<strong>Uṇādi 3.39:</strong> Suffix 'nu' creates the Noun form."
            },
            {
                text: "Śaśivarṇaṁ",
                meaning: "Moon-Colored (Cooling)",
                binary: "0011",
                split: "<span class='comp'>Śaśin</span> (Moon) + <span class='comp'>Varṇaṁ</span> (Color)",
                root: "Compound Word (Bahuvrīhi)",
                rule: "<strong>2.2.24 Anekamanyapadārthe:</strong> 'One whose color is like the Moon'"
            },
            {
                text: "Caturbhujam",
                meaning: "Four-Armed (4 States)",
                binary: "0101",
                split: "<span class='comp'>Catur</span> (Four) + <span class='comp'>Bhujam</span> (Arms)",
                root: "Compound Word (Dvigu)",
                rule: "<strong>2.1.52 Saṅkhyāpūrvo Dviguḥ:</strong> 'One who possesses four arms'"
            },
            {
                text: "Prasannavadanaṁ",
                meaning: "Tranquil Face",
                binary: "010001",
                split: "<span class='comp'>Pra-sanna</span> (Settled) + <span class='comp'>Vadanaṁ</span> (Face)",
                root: "From Root <span class='root-hl'>√sad</span> (To Sit/Settle)",
                rule: "<strong>6.1.108 Samprasāraṇa:</strong> d → n (Assimilation)"
            },
            {
                text: "Dhyāyet",
                meaning: "Meditate Upon",
                binary: "11",
                split: "<span class='comp'>√dhyai</span> + <span class='comp'>Lin</span> (Should Do)",
                root: "From Root <span class='root-hl'>√dhyai</span> (To Meditate)",
                rule: "<strong>3.3.161 Vidhi-Lin:</strong> Potential Mood (Optative)"
            },
            {
                text: "Sarvavighnop",
                meaning: "All Obstacles",
                binary: "1011",
                split: "<span class='comp'>Sarva</span> (All) + <span class='comp'>Vighna</span> (Noise) + <span class='comp'>Upa...</span>",
                root: "Sandhi Junction",
                rule: "<strong>6.1.87 Ād Guṇaḥ:</strong> a + u = o (Guṇa Sandhi)"
            },
            {
                text: "ashāntaye",
                meaning: "For Total Peace",
                binary: "0101",
                split: "<span class='comp'>...Upa</span> (Near) + <span class='comp'>Śāntaye</span> (Peace)",
                root: "From Root <span class='root-hl'>√śam</span> (To Be Calm)",
                rule: "<strong>2.3.13 Caturthi Sampradane:</strong> Dative Case (Purpose)"
            }
        ];

        const verseBinary = verseData.map(w => w.binary).join('');

        // Full verse text for phonetic analysis (Approximate transliteration mapping)
        // Ideally we would parse the Devanagari directly, but for this demo let's use the explicit string
        const verseDevanagari = "शुक्लाम्बरधरं विष्णुं शशिवर्णं चतुर्भुजम् प्रसन्नवदनं ध्यायेत् सर्वविघ्नोपशान्तये";

        // === LOGIC ===

        function init() {
            renderWords();
            renderBinaryStrip(verseBinary);
            calculateMath(verseBinary);
            drawMeru(verseBinary);
            calculateEnergy(verseDevanagari);


            // Initialize Phonetic Identity (Calculated for restoration, but not displayed)
            globalPhoneticID = generatePhoneticID(verseDevanagari);

            drawPaniniFractal();
        }

        function drawPaniniFractal() {
            const canvas = document.getElementById('paniniFracCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            ctx.clearRect(0, 0, width, height);

            // The Panini Path: [1.951, 4, 101, 9] represented as binary choices
            // Root 1.951 (Bhvadi 951) = 1110110111
            // Suffix 4 = 100
            // Rule 101 = 1100101
            // Output 9 = 1001

            const pathSegments = [
                { val: 951, bits: "1110110111", color: "#a855f7", label: "√dhṛ (1.951)" },
                { val: 4, bits: "100", color: "#3b82f6", label: "suf-Am (4)" },
                { val: 101, bits: "1100101", color: "#ef4444", label: "6.1.101" },
                { val: 9, bits: "1001", color: "#10b981", label: "Out (9)" }
            ];

            const startX = width / 2;
            const startY = 40;
            const stepY = 12;
            const stepX = 12;

            let currentX = startX;
            let currentY = startY;

            // Draw Triangle Grid (Background)
            ctx.fillStyle = "rgba(255,255,255,0.03)";
            for (let r = 0; r < 28; r++) {
                for (let c = 0; c <= r; c++) {
                    const x = startX - (r * stepX) / 2 + c * stepX;
                    const y = startY + r * stepY;
                    ctx.beginPath();
                    ctx.arc(x, y, 1.5, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            // Draw Path
            // We can visualize the "Descent" as a continuous line where 0=Left, 1=Right

            ctx.lineWidth = 3;
            ctx.lineCap = "round";
            ctx.lineJoin = "round";

            pathSegments.forEach(seg => {
                ctx.beginPath();
                ctx.moveTo(currentX, currentY);
                ctx.strokeStyle = seg.color;

                // Draw circle at start of segment
                ctx.fillStyle = seg.color;
                ctx.arc(currentX, currentY, 4, 0, Math.PI * 2);
                ctx.fill();

                for (let bit of seg.bits) {
                    // Logic: 0 goes Left-Down, 1 goes Right-Down

                    const nextY = currentY + stepY;
                    const nextX = (bit === '1') ? currentX + stepX / 2 : currentX - stepX / 2;

                    ctx.lineTo(nextX, nextY);

                    currentX = nextX;
                    currentY = nextY;
                }
                ctx.stroke();

                // Draw label at end of segment
                ctx.fillStyle = seg.color;
                ctx.font = "10px JetBrains Mono";
                ctx.fillText(seg.label, currentX + 10, currentY);
            });

            // Final Node
            ctx.beginPath();
            ctx.arc(currentX, currentY, 6, 0, Math.PI * 2);
            ctx.fillStyle = "#10b981";
            ctx.fill();
            ctx.shadowBlur = 10;
            ctx.shadowColor = "#10b981";
            ctx.stroke();
            ctx.shadowBlur = 0;
        }

        function renderWords() {
            const container = document.getElementById('wordGrid');
            container.innerHTML = '';

            verseData.forEach(w => {
                const decimal = parseInt(w.binary, 2);
                const bits = w.binary.split('').map(b =>
                    `<span class="bit-mini ${b === '1' ? 'guru' : 'laghu'}"></span>`
                ).join('');

                const html = `
                    <div class="word-card">
                        <span class="sanskrit-word">${w.text}</span>
                        <span class="english-meaning">${w.meaning}</span>

                        <!-- Panini Layer -->
                        <div class="grammar-section">
                            <div class="step-label" style="font-size:0.7em; color:#9333ea;">Grammar DNA</div>
                            <div class="split-view">${w.split}</div>
                            <div class="root-def">${w.root}</div>
                            <span class="sutra-ref">${w.rule}</span>
                        </div>

                        <!-- Pingala Layer -->
                        <div style="margin-top:10px; border-top:1px solid #334155; padding-top:10px;">
                            <div class="step-label" style="font-size:0.7em;">Pingala Binary</div>
                            <div style="display:flex; gap:2px; margin-bottom:5px;">${bits}</div>
                            <div style="font-family:'JetBrains Mono'; color:var(--gold); font-size:0.9em;">
                                Bin: ${w.binary} | Dec: ${decimal}
                            </div>
                        </div>
                    </div>
                 `;
                container.innerHTML += html;
            });
        }

        function renderBinaryStrip(binary) {
            const container = document.getElementById('binaryStrip');
            const bits = binary.split('');

            bits.forEach(bit => {
                const el = document.createElement('div');
                el.className = `bit ${bit === '1' ? 'guru' : 'laghu'}`;
                el.textContent = bit === '1' ? 'G' : 'L'; // G = Guru (Long), L = Laghu (Short)
                container.appendChild(el);
            });

            document.getElementById('binaryRaw').textContent = binary;
        }

        // Phontic Map (Panini Engine)
        const phoneticMap = {
            // Vowels
            'अ': [1, 0, 0, 0, 0], 'आ': [1, 0, 0, 0, 0], 'इ': [0, 1, 0, 0, 0], 'ई': [0, 1, 0, 0, 0],
            'उ': [0, 0, 0, 0, 1], 'ऊ': [0, 0, 0, 0, 1], 'ऋ': [0, 0, 1, 0, 0], 'ए': [0, 1, 0, 0, 0],
            'ऐ': [0, 1, 0, 0, 0], 'ओ': [0, 0, 0, 0, 1], 'औ': [0, 0, 0, 0, 1],
            // Gutturals (क-वर्ग)
            'क': [1, 0, 0, 0, 0], 'ख': [1, 0, 0, 0, 0], 'ग': [1, 0, 0, 0, 0], 'घ': [1, 0, 0, 0, 0], 'ङ': [1, 0, 0, 0, 0],
            // Palatals (च-वर्ग)
            'च': [0, 1, 0, 0, 0], 'छ': [0, 1, 0, 0, 0], 'ज': [0, 1, 0, 0, 0], 'झ': [0, 1, 0, 0, 0], 'ञ': [0, 1, 0, 0, 0],
            // Cerebrals (ट-वर्ग)
            'ट': [0, 0, 1, 0, 0], 'ठ': [0, 0, 1, 0, 0], 'ड': [0, 0, 1, 0, 0], 'ढ': [0, 0, 1, 0, 0], 'ण': [0, 0, 1, 0, 0],
            // Dentals (त-वर्ग)
            'त': [0, 0, 0, 1, 0], 'थ': [0, 0, 0, 1, 0], 'द': [0, 0, 0, 1, 0], 'ध': [0, 0, 0, 1, 0], 'न': [0, 0, 0, 1, 0],
            // Labials (प-वर्ग)
            'प': [0, 0, 0, 0, 1], 'फ': [0, 0, 0, 0, 1], 'ब': [0, 0, 0, 0, 1], 'भ': [0, 0, 0, 0, 1], 'म': [0, 0, 0, 0, 1],
            // Semi-vowels
            'य': [0, 1, 0, 0, 0], 'र': [0, 0, 1, 0, 0], 'ल': [0, 0, 0, 1, 0], 'व': [0, 0, 0, 0, 1],
            // Sibilants
            'श': [0, 1, 0, 0, 0], 'ष': [0, 0, 1, 0, 0], 'स': [0, 0, 0, 1, 0], 'ह': [1, 0, 0, 0, 0]
        };

        function calculateEnergy(text) {
            let counts = [0, 0, 0, 0, 0]; // Ether, Air, Fire, Water, Earth
            let total = 0;

            // Scan text
            for (let char of text) {
                if (phoneticMap[char]) {
                    const vec = phoneticMap[char];
                    for (let i = 0; i < 5; i++) {
                        if (vec[i]) {
                            counts[i]++;
                            total++;
                        }
                    }
                }
            }

            // Render Bar
            const bar = document.getElementById('energyBar');
            bar.innerHTML = '';
            const colors = ['e-ether', 'e-air', 'e-fire', 'e-water', 'e-earth'];
            const names = ['Ether', 'Air', 'Fire', 'Water', 'Earth'];

            counts.forEach((c, i) => {
                if (c > 0) {
                    const pct = (c / total) * 100;
                    const el = document.createElement('div');
                    el.className = `energy-seg ${colors[i]}`;
                    el.style.width = pct + "%";
                    el.title = `${names[i]}: ${pct.toFixed(1)}%`;
                    bar.appendChild(el);
                }
            });
        }

        function calculateMath(binary) {
            // BigInt for 32-bit safety
            const decimal = BigInt("0b" + binary);
            document.getElementById('decimalVal').textContent = decimal.toString();

            // Check Factors (simplified for demo UI, limited range)
            const num = Number(decimal); // JS Number safe up to 2^53, 32 bit is fine (approx 4 billion)

            // It's likely composite for a random verse, but let's check
            const factors = getPrimeFactors(num);
            const isPrime = factors.length === 1; // If only factor is itself (and 1 excluded)

            const statusEl = document.getElementById('primeStatus');
            if (isPrime) {
                statusEl.textContent = "PRIME (Stable)";
                statusEl.style.color = "#10b981";
            } else {
                statusEl.textContent = "COMPOSITE (Harmonic)";
                statusEl.style.color = "#f59e0b";
            }

            document.getElementById('factorsVal').textContent = factors.join(' × ');

            // Final Hash Generation
            // Meru OS Verse ID = (Decimal % 108) + "." + (FirstFactor) + "." + (BinaryChecksum)
            const checksum = binary.split('1').length - 1; // Population count
            const finalCode = `MERU-V-${num.toString().slice(0, 4)}-${factors[0]}-${checksum}`;

            document.getElementById('finalCode').textContent = finalCode;
        }

        function getPrimeFactors(n) {
            const factors = [];
            let divisor = 2;
            let temp = n;

            while (temp >= 2) {
                if (temp % divisor === 0) {
                    factors.push(divisor);
                    temp = temp / divisor;
                } else {
                    divisor++;
                    // Optimization: if divisor^2 > temp, remainder is prime
                    if (divisor * divisor > temp) {
                        if (temp > 1) factors.push(temp);
                        break;
                    }
                }
            }
            return factors;
        }

        // === CANVAS (Meru) ===
        function drawMeru(pattern) {
            const canvas = document.getElementById('meruCanvas');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            ctx.clearRect(0, 0, width, height);

            const rows = 12; // Show top 12 rows
            const cellSize = 30;
            const startY = 30;

            const patternBits = pattern.split('').map(Number);

            for (let r = 0; r < rows; r++) {
                const rowWidth = (r + 1) * cellSize;
                const startX = (width - rowWidth) / 2 + cellSize / 2;
                const y = startY + r * cellSize;

                // Determine path column for this row based on pattern pattern
                // Logic: 0 = Left (keep col), 1 = Right (col + 1)
                // We track cumulative sum
                let pathCol = 0;
                if (r > 0 && r <= patternBits.length) {
                    // slice(0, r) takes first r bits to determine which cell we fell into
                    // Actually, usually bit 0 determines row 1 choice.
                    // For visualization:
                    // Row 0: Peak
                    // Row 1: Left(0) or Right(1)
                    const bitsSoFar = patternBits.slice(0, r);
                    pathCol = bitsSoFar.reduce((a, b) => a + b, 0);
                }

                for (let c = 0; c <= r; c++) {
                    const x = startX + c * cellSize;

                    // Is this cell on the path?
                    // We only highlight if we have enough bits to define this row
                    let isPath = false;
                    if (r <= patternBits.length) {
                        if (c === pathCol) isPath = true;
                    }

                    // Draw Node
                    ctx.beginPath();
                    ctx.arc(x, y, 10, 0, Math.PI * 2);
                    if (isPath) {
                        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent');
                        ctx.shadowBlur = 10;
                        ctx.shadowColor = ctx.fillStyle;
                    } else {
                        ctx.fillStyle = 'rgba(255,255,255,0.1)';
                        ctx.shadowBlur = 0;
                    }
                    ctx.fill();
                    ctx.closePath();

                    // Connecting Lines (Subtle)
                    if (r < rows - 1) {
                        // Simple visual lines not strictly necessary for abstract path demo
                    }
                }
            }
        }

        // === PHONETIC ENGINE (Bi-Directional) ===
        const SKT_ALPHABET = " अआइईउऊऋएऐओऔकखगघङचछजझञटठडढणतथदधनपफबभमयरलवशषसहािीुूृेैोौ्ंः।॥0123456789";
        const charMap = {};
        for (let i = 0; i < SKT_ALPHABET.length; i++) {
            charMap[SKT_ALPHABET[i]] = BigInt(i);
        }

        let globalPhoneticID = 0n;

        function generatePhoneticID(text) {
            let id = 0n;
            for (let char of text) {
                let val = charMap[char];
                if (val === undefined) val = 0n; // Fallback to Space
                id = (id << 7n) | val; // 7 bits for 70 chars
            }
            return id;
        }

        function decodePhoneticID(id) {
            let tempId = id;
            let recovered = "";
            const mask = 127n; // 7 bits (1111111)

            while (tempId > 0n) {
                const val = Number(tempId & mask);
                const char = SKT_ALPHABET[val];
                if (char) recovered = char + recovered;
                tempId = tempId >> 7n;
            }
            return recovered;
        }

        function restoreVerse() {
            const area = document.getElementById('restorationArea');
            area.textContent = "";
            const text = decodePhoneticID(globalPhoneticID);

            let i = 0;
            const interval = setInterval(() => {
                area.textContent += text[i];
                i++;
                if (i >= text.length) clearInterval(interval);
            }, 50);
        }

        // Run
        window.onload = init;

    </script>
</body>

</html>